<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:fragment="headerfiles">

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/album/">

    <!-- Bootstrap core CSS -->
    <link th:href="@{css/bootstrap.css}" rel="stylesheet">
    <link th:href="@{css/stylesheet.css}" rel="stylesheet">

    <!-- For dropdown to work -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
<div th:fragment="evidenceForm">
        <div class="portion_body"  style="display: none" id="evidence_form">
        <form th:action="@{add-evidence}" method="post">
                <div class="row-1" style="display:flex;">
                        <div class="evidence_form_element col-4">
                            <b class="evidence_head setWide">Title*:</b><br> <input type="text" id="evidence_title" maxlength="100" class="project_edit_data" th:name="titleInput" oninput="updateTitle(); canSaveCheck()" required>
                            <label class="project_inputAlertBlue" id="titleCharCount">Characters Remaining: 100</label>
                        </div>
                    <div id="date_container" class="evidence_form_element col-3">
                        <div style="display: flex">
                            <b class="evidence_head">Date*:</b> <br>
                            <i id="evidence_date_tool" class="fa fa-question-circle-o" style="padding-left: 0.2em; font-size: 200%"></i>


                        </div>
                        <script>
                            let dateTooltip = '<span class="tooltip_body_evidence">This is the date the evidence occurred, date selection is restricted to the boundaries of the project it is assigned to.</span>'

                            $("#evidence_date_tool").tooltip({
                                title: dateTooltip,
                                placement: "top",
                                trigger: "hover",
                                container: "body",
                                html: true
                            });
                        </script>
                            <input type="date" th:name="dateInput" th:value="${date}"
                                   th:attr="min=${project.getStartDateStringHtml()}, max=${project.getEndDateStringHtml()}"
                                   class="project_edit_data" id="date_input"
                                   oninput="canSaveCheck()" required
                            >
                        </div>
                        <div class="evidence_form_element align-content-center col-5">
                                <b class="evidence_head setWide">Category:</b><br>
                                <div id="evidence_category" class="project_edit_data" onclick="showCategories()">
                                    Select Categories
                                </div>
                            <div id="category_multiselect_items" class="category_box" style="display: none">
                                <label for="category_quantitative" class="category_item" style="display: block">
                                    <input type="checkbox" autocomplete="off" class="category_item" value="Quantitative Skills" id="category_quantitative" onchange="updateCategories(this)" />
                                    Quantitative Skills
                                </label>
                                <label for="category_qualitative" class="category_item" style="display: block">
                                    <input type="checkbox" autocomplete="off" class="category_item" value="Qualitative Skills" id="category_qualitative" onchange="updateCategories(this)" />
                                    Qualitative Skills
                                </label>
                                <label for="category_service" class="category_item" style="display: block">
                                    <input type="checkbox" autocomplete="off" class="category_item" value="Service" id="category_service" onchange="updateCategories(this)" />
                                    Service
                                </label>
                            </div>
                        </div>
                    <input type="hidden" id="category_hidden" th:name="categoryInput">
                    <script>
                        let categoryOptionsShown = true;
                        let selectedCategories = new Set()

                        function storeCategories() {
                            let categoryStore = document.getElementById("category_hidden")
                            const categoriesToSave = Array.from(selectedCategories).join('~');
                            categoryStore.value = categoriesToSave
                        }

                        function showCategories() {
                            let categoryOptions = document.getElementById("category_multiselect_items")
                            if (categoryOptionsShown) {
                                categoryOptions.style.display = "block"
                                categoryOptionsShown = false
                            } else {
                                categoryOptions.style.display = "none"
                                categoryOptionsShown = true
                            }
                        }

                        function updateCategories(event) {
                            newCategory = event.value
                            if (selectedCategories.has(newCategory)) {
                                selectedCategories.delete(newCategory)
                            } else {
                                selectedCategories.add(event.value)
                            }
                            let categoryDisplay = document.getElementById("evidence_category")
                            if (selectedCategories.size == 0) {
                                categoryDisplay.innerText = "Select Categories"
                            } else {
                                categoryDisplay.innerText = [...selectedCategories].join(', ')
                            }
                        }

                        document.addEventListener("click", function (e) {
                            let categoryOptions = document.getElementById("category_multiselect_items")
                            if (e.target != document.getElementById("evidence_category") && e.target.className != "category_item") {
                                categoryOptions.style.display = "none"
                                categoryOptionsShown = true
                            }
                        });
                    </script>
                </div>
                    <br>
                    <br>
                    <br>

                <div class="row-1">
                    <div>
                        <b class="evidence_head setWide">Description*:</b>
                        <br>
                        <textarea type="text" maxlength="2000" id="evidence_desc" oninput="updateDesc(); canSaveCheck()"
                                  class=" description-input project_edit_data horizontal_field bio setWide"
                                  th:name="descriptionInput" required
                        ></textarea>
                        <label class="project_inputAlertBlue" id="descCharCount">Characters Remaining: 2000</label>
                    </div>
                    <input type="number" th:name="projectId" th:value="${project.getId}" style="display: none" >
                    <!-- When enter is pressed, default form action is to submit the first button. As our form contains buttons, this empty button exists to consume the default action. -->
                    <button onclick="return false;" style="display: none"></button>
                    <div class="row-1">
                        <b class="evidence_head setWide" id="skills_input">Skills:</b>
                        <p style="display:none;" id="skill_error">Only letters, underscores, hyphens, and numbers are allowed</p>
                    </div>
                    <div class="col-12" id="skills_div" style="display: flex; justify-content: center; align-items: center;">
                            <!-- Style for padding and margin here place the button inside the input, and ensure text won't collide with button -->
                        <div class="evidence_form_element_wide">
                        <div class="autocomplete evidence_form_element_wide">
                            <input type="hidden" id="skillHidden" th:name="skillInput">
                        <input type="text" autocomplete="off" id="add_skill_input" maxlength=100 oninput="updateSkills()"  class="evidence_form_element_wide project_edit_data">
                        </input>
                        </div>
                        </div>
                       <button id="add_skill_button" type="button" style="margin-left: 1em" class="table_text user_role_table" th:text="Add" onclick="addSkill(); return false;"></button>
                    </div>
                    <label class="project_inputAlertBlue" id="skillCharCount" style="padding-left: 5px">Characters Remaining: 100</label>
                    <br>
                    <div id="skills_container" style="width: 100%">
                        <div id="skill_sub_1" style="display: flex; width: 100%"></div>
                    </div>
                    <script>
                        // Event listener to add skills when enter is pressed and the skill input is selected
                        document.querySelector("#add_skill_input").addEventListener("keyup", event => {
                            if (event.key !== "Enter") return;
                            addSkill()
                        })

                        //Returns the skills
                        function storeSkills() {
                            let skillStore = document.getElementById("skillHidden")
                            const skillList = Array.from(skills).join('~');
                            skillStore.value = skillList
                        }

                        let skills = new Set()
                        let skillRow = document.getElementById("skill_sub_1");

                        // Adds the skill to the set and resets the input.
                        function addSkill() {
                            let newSkill = document.getElementById("add_skill_input").value
                            if (skills.has(newSkill)) return;
                            // check to see if it matches the correct skill format
                            const validate = newSkill.match(/^[a-zA-Z-_0-9]+$/)
                            if (!validate || !validate.length == 1) {
                                document.getElementById("skill_error").style = "color:red;";
                                return
                            }
                            skills.add(newSkill)
                            allSkills = allSkills.filter(s => s !== newSkill)
                            autocomplete(document.getElementById("add_skill_input"), allSkills)
                            document.getElementById("add_skill_input").value = ""
                            appendSkill(newSkill)
                        }

                        // Inserts a new skill tag into the form
                        function appendSkill(skillText) {
                            let skillTag = document.createElement("button");
                            skillTag.id = "skill_" + skillText
                            skillTag.className = "table_text skill_tag"
                            skillTag.innerText = skillText + " ✖"
                            skillTag.value = skillText
                            skillTag.onclick = removeSkill;
                            skillRow.appendChild(skillTag);
                            if (skillRow.getBoundingClientRect().right < skillTag.getBoundingClientRect().right) {
                                skillRow.removeChild(skillTag)
                                insertSkillRow()
                                skillRow.appendChild(skillTag);
                            }
                            storeSkills()
                        }

                        /* Creates a new row for skill tags to be placed on, for some reason inserting <br> couldn't do this*/
                        function insertSkillRow() {
                            let newSkillRow = document.createElement("div");
                            newSkillRow.style.display = "flex"
                            document.getElementById("skills_container").appendChild(newSkillRow)
                            skillRow = newSkillRow
                        }

                        // Deletes a skill then rebuilds the skill list
                        function removeSkill(event) {
                            skills.delete(event.target.value)
                            allSkills.push(event.target.value)
                            autocomplete(document.getElementById("add_skill_input"), allSkills)
                            clearSkills()
                            insertSkillRow()
                            for (const skill of skills) {
                                appendSkill(skill)
                            }
                            return false;
                        }

                        // Removes all skills from display
                        function clearSkills() {
                            let skillContainer = document.getElementById("skills_container")
                            while (skillContainer.lastChild) {
                                skillContainer.removeChild(skillContainer.lastChild)
                            }
                        }
                    </script>

                    <!-- Start of link section of the form, which includes the 1. "Links" title, 2. input, and 3. list of inputted links -->
                    <div class="col-12">
                        <!-- 1. "Links" title-->
                        <b class="evidence_head setWide" id="links_input">Links:</b><br>

                        <!-- 2. Input field where user can add links -->
                        <div class="col-12" id="links_div" style="display: flex; justify-content: center; align-items: center;">
                            <!-- Style for padding and margin here place the button inside the input, and ensure text won't collide with button -->
                            <input type="text" id="add_link_input" class="evidence_form_element_wide project_edit_data">
                            <button id="add_link_button" type="button" style="margin-left: 1em" class="table_text user_role_table" th:text="Add" onclick="addLink(); return false;"></button>
                            </input>
                        </div><br>


                        <div id="links_and_submit" style="display: flex">

                            <!-- 3. List of all the links the user added from the input field -->
                            <div id="links_container" style="width: 85%; display: block">
                                <input type="hidden" id="linksInput" th:name="linksInput">
                            </div>

                            <div id="submit_and_cancel" style="width: 15%; display: block; justify-content: left">
                                <button class="cancel_evidence" onclick="displayAddButton()" id="cancelButton" type="button">CANCEL</button>
                                <button class="save_evidence" id="projectSave" style="background: lightgray" type="submit" disabled>SAVE</button>
                            </div>
                        </div>
                    </div>
                    <script>
                        // Event listener to add links when enter is pressed and the link input is selected
                        document.querySelector("#add_link_input").addEventListener("keyup", event => {
                            if (event.key !== "Enter") return;
                            addLink()
                        })

                        let links = new Set();
                        let linksContainer = document.getElementById("links_container")
                        let linkCounter = 0;

                        // Adds the link to the set and resets the input.
                        function addLink() {
                            let newLink = document.getElementById("add_link_input").value
                            if (newLink === "") {
                                return;
                            }
                            if (!validateLink(newLink)) {
                                alert('Link is not valid, please ensure link includes http(s):// protocol');
                                return;
                            }
                            if (links.has(newLink)) return;
                            links.add(newLink)
                            document.getElementById("add_link_input").value = ""
                            appendLink(newLink)
                        }

                        // Validate a link
                        function validateLink(link) {
                            let pattern = /^https?:\/\/.*$/
                            return pattern.test(link);
                        }

                        // Inserts a new link into the form
                        function appendLink(linkText) {
                            let linkBox = document.createElement("div");
                            linksContainer.appendChild(linkBox)
                            linkBox.className = "trim_text"
                            linkBox.style.display = "flex"
                            let newLink = document.createElement("a");
                            newLink.id = "link_" + linkText
                            newLink.className = "sprint-description display_data text_button trim_text"
                            newLink.style.fontSize = "110%"
                            newLink.width = "90% !important"
                            newLink.style.display = "inline-block"
                            linkCounter++
                            newLink.innerText = linkCounter + ".  " + linkText
                            newLink.href = linkText
                            let linkDelete = document.createElement("button");
                            linkDelete.className = "fa fa-trash each_link"
                            linkDelete.value = linkText
                            linkDelete.onclick = removeLink;
                            linkBox.appendChild(newLink)
                            linkBox.appendChild(linkDelete)
                            storeLinks()
                        }

                        // Store the javascript set of links into a hidden HTML divider,
                        // which can be retrieved in Java from the linkInput ID
                        // This is to transfer the frontend set of links into the backend.
                        function storeLinks() {
                            let linksInput = document.getElementById("linksInput")
                            const linkList = Array.from(links).join(' ');
                            linksInput.value = linkList
                        }

                        // Deletes a link then rebuilds the link list
                        function removeLink(event) {
                            links.delete(event.target.value)
                            clearLinks()
                            linkCounter = 0
                            for (const link of links) {
                                appendLink(link)
                            }
                            return false;
                        }

                        // Removes all links from display
                        function clearLinks() {
                            let linkContainer = document.getElementById("links_container")
                            while (linkContainer.lastChild) {
                                linkContainer.removeChild(linkContainer.lastChild)
                            }
                        }

                        function updateTitle() {
                            const titleCounter = document.getElementById("titleCharCount")
                            const titleInput = document.getElementById("evidence_title")
                            titleCounter.innerText = "Characters Remaining: "  + (100 - titleInput.value.length)
                        }

                        function updateDesc() {
                            const descCounter = document.getElementById("descCharCount")
                            const descInput = document.getElementById("evidence_desc")
                            descCounter.innerText = "Characters Remaining: "  + (2000 - descInput.value.length)
                        }

                        function updateSkills() {
                            const skillCounter = document.getElementById("skillCharCount")
                            const skillInput = document.getElementById("add_skill_input")
                            skillCounter.innerText = "Characters Remaining: "  + (100 - skillInput.value.length)
                        }

                        // Enable form and hide add evidence form
                        function displayAddEvidenceForm() {
                            document.getElementById('evidence_form').style = "display: block";
                            document.getElementById('add_button').style = "display: none";
                        }

                        // Enable add evidence button and hide form
                        function displayAddButton() {
                            document.getElementById('evidence_form').style = "display: none";
                            document.getElementById('add_button').style = "display: block";
                        }
                    </script>
                </div>
        </form>
        </div>
    <br>
    <div class="row">
        <div class="col-1"></div>
        <button class="add_evidence col-10" onclick="displayAddEvidenceForm(); canSaveCheck()" id="add_button"> + Add Evidence </button>
        <div class="col-1"></div>
    </div>
    <script type="text/javascript" th:src="@{js/autocomplete.js}"></script>
    <script th:inline="javascript">
        let allSkills = [[${autoSkills}]];
        autocomplete(document.getElementById("add_skill_input"), allSkills);
    </script>
</div>
</body>
</html>

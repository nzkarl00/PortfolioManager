<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="fragments/head.html :: head('Groups')"></head>
<body>



<!-- Navigation Bar -->
<div th:replace="fragments/validUser.html :: navbar"></div>



<!-- Body -->
<div class="container">
    <div class="row-1">
        <br><br>
    </div>
    <br>
    <div class="row">
        <div class="col-2">
        </div>
        <form class="col-lg-8 col-md-10 col-sm-12" th:style="${display}" th:action="@{addGroup}" method="get">
            <button class="add" type="submit">
                Add Group
            </button>
            <br>
            <br>
            <div cstyle="display:flex">
                <a th:href="${'groups?page=' + (currentPage-1)}" class="btn btn-primary align-text-left">←</a>
                Page <span class="table_text" th:text="${' ' + currentPage}"></span>
                <a th:href="${'groups?page=' + (currentPage+1)}" class="btn btn-primary align-text-left">→</a>
            </div>
        </form>
    </div>

    <div th:each="group: ${groups}">
        <br>
        <div class="row">

            <div class="col-2">
            </div>

        <!-- Groups Section -->
            <div class="col-lg-8 col-md-10 col-sm-12 portion_body" >
                <a class="project_a" th:href="@{editGroup(id=${group.getId})}" >
                    <h3 class="project_subhead" th:text="${'(' + (group.shortName) + ') ' + group.longName}"/>
                </a>
                <br>
                <div>
                    <!-- Users -->
                    <div class="user-table">
                        <table class="table" th:attr="onclick=|setLatest(${group.id})|"  th:id="${'groupUserTable' + group.shortName}">
                            <thead>
                            <tr class="justify-content-center">
                                <th class="table_head justify-content-center text-center"scope="col" >
                                    Id
                                </th>

                                <th class="table_head justify-content-center text-center"scope="col" >
                                    First Name
                                </th>
                                <th class="table_head justify-content-center text-center" scope="col">
                                    Last Name
                                </th>
                                <th class="table_head justify-content-center text-center" scope="col">
                                    Username
                                </th>
                                <th class="table_head justify-content-center text-center" scope="col">
                                    Alias
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:if="${group.getMembers.empty}">
                                <td colspan="5"> Could not get users to list </td>
                            </tr>
                            <tr th:each="user : ${group.getMembers}">
                                <td><span class="table_text" th:text="${user.id}"> Id </span></td>
                                <td><span class="table_text" th:text="${user.firstName}"> First </span></td>
                                <td><span class="table_text" th:text="${user.lastName}"> Last </span></td>
                                <td><span class="table_text" th:text="${user.username}"> Username </span></td>
                                <td><span class="table_text" th:text="${user.nickname}"> Alias </span></td>
                            </tr>
                            </tbody>
                        </table>
                </div>
            </div>

            <div class="col-2">
            </div>

            <div class="col-4">
                <br>
                <br>
            </div>
    </div>
  </div>
</div>
</div>
</body>

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
let clipboard = [[${clipboard}]];
let selected = [];
let latest;

function removeFromSelected(item) {
    let i = 0;
    for (const user of selected) {
        if (user === item) {
            selected.splice(i);
        }
        i++;
    }
}

function setLatest(id) {
console.log(id)
    latest = id
}

// https://www.geeksforgeeks.org/how-to-detect-copy-paste-commands-ctrlv-ctrlc-using-javascript/
document.body.addEventListener("keydown", function (ev) {

    // function to check the detection
    ev = ev || window.event;  // Event object 'ev'
    var key = ev.which || ev.keyCode; // Detecting keyCode

    // Detecting Ctrl
    var ctrl = ev.ctrlKey ? ev.ctrlKey : ((key === 17)
        ? true : false);

    // If key pressed is V and if ctrl is true.
    if (key == 86 && ctrl) {
        axios.patch("/ctrlv", {"params":{"groupId": latest, "ids":clipboard}})
    } else if (key == 67 && ctrl) {
        clipboard = []
        for (const user of selected) {
            clipboard.push(parseInt(user))
        }
    }

}, false);

/*<![CDATA[*/

    /*[# th:each="group : ${groups}"]*/
        $(document).ready(function () {
            var table = $('#groupUserTable' + /*[[${group.shortName}]]*/).DataTable( {
                                select: true
                            } );

            $('#groupUserTable' + /*[[${group.shortName}]]*/ + ' tbody').on('click', 'tr', function () {
                let id = table.row(this).data()[0].substring(25)
                latest = [[${group.id}]]
                id = id.substring(0, id.length - 7)
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                    removeFromSelected(id)
                }
                else {
                    $(this).addClass('selected');
                    selected.push(id);
                }
            });
        });
    /*[/]*/

/*]]>*/
</script>

</html>

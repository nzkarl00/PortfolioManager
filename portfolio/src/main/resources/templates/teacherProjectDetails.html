<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${project.getName}"></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/album/">

    <!-- Bootstrap core CSS -->
    <link th:href="@{css/bootstrap.css}" rel="stylesheet">
    <link th:href="@{css/stylesheet.css}" rel="stylesheet">
    <!-- For dropdown to work -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- For the FullCalendar to work -->
    <link th:href="@{css/fullcalendar.css}" rel="stylesheet">
</head>
<body>


<!-- Navigation Bar -->
<div th:replace="fragments/validUser.html :: navbar"></div>



<!-- Body -->
<div class="main">
    <div class="container">

        <div class="row-1">
            <br><br><br>
        </div>

        <!-- Editing heading -->

        <div class="row-1">

            <div class="col-12 ">
                <p class="body_title_large " th:text="${project.getName}" />
                <p class="header_project_dates" th:text="'Start Date: ' + ${project.getStartDateString} + ' - ' + 'End Date: ' + ${project.getEndDateString}"/>
                <br>
            </div>

        </div>

        <!-- Tab Buttons -->
        <ul class="nav nav-tabs h4" style="font-family: nexaBold;">
            <li id="toCalendar" class="active"><a data-toggle="tab" href="#calendar-tab" id="calendar-tab-head">Planner</a></li>
            <li id="toDetails"><a data-toggle="tab" href="#project-details-tab" id="details-tab-head">Project Details</a></li>
        </ul>

        <!-- Tab containers-->
        <div class="tab-content">
            <div id="calendar-tab" class="tab-pane fade in active">
                <br><br>

                <div id="calendar"></div>

                <br>
                <br>

                <button class="signup_box_green "th:style="${successCalendarShow}">
                    <p class="signup_error_green" th:text="${successCalendarCode}"/>
                </button>
                <button class="signup_box"th:style="${errorCalendarShow}">
                    <p class="signup_error" th:text="${errorCalendarCode}"/>
                </button>
            </div>

            <div id="project-details-tab" class="tab-pane fade">
                <br><br>

                <div class="row">
                    <div class="col-2"></div>
                    <div class="col-lg-8 col-md-10 col-sm-12 portion_body">
                    <div class="col-lg-8 col-md-10 col-sm-12 portion_body">

                        <p class="detail_date " th:text="${project.getStartDateString} + ' - ' + ${project.getEndDateString}" />

                            <div class="horizontal_field project_subtext" th:text="${project.getDescription}" /> </div>

                        <div class="col-2"></div>

                </div>

                <div class="row">
                    <div class="col-2"></div>

                        <!-- Buttons -->
                        <div class="col-lg-8 col-md-10 col-sm-12">

                            <button class="edit" style="padding-top:0rem;">
                                <a class="button_a" th:href="@{edit-project(id=${project.getId})}">Edit Project</a>
                            </button>

                        </div>
                        <div class="col-2"></div>

                    </div>
                    <br>
                    <p></p>
                    <div id="sprints">
                        <!-- where to insert all the sprint details in the js method buildSprint-->
                    </div>

                    <div class="row">

                        <div class="col-2"></div>

                        <!-- Buttons -->

                        <div class="col-lg-8 col-md-10 col-sm-12" >
                            <form th:action="@{new-sprint}" method="post">
                                <input style="display:none;" th:name="projectId" id="projectId" th:value="${project.getId}" type="number">
                                <button class="add" type="submit">
                                    Add Dates
                                </button>
                            </form>
                            <br>
                            <button class="login_box "th:style="${errorShow}">
                                <p class="login_error" th:text="${errorCode}"/>
                            </button>
                            <button class="edit ">
                                <a class=" button_a" th:href="@{landing}">      Return      </a>
                            </button>
                            <br><br>
                        </div>

                        <div class="col-2"></div>

                    </div>

                    <div class="row-1">
                        <br><br><br>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>


<!-- Javascript for the calendar -->
<script src="/webjars/jquery/jquery.min.js"></script>
<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript" th:inline="javascript">

    let flag = false;

    $('#calendar-tab').on('click', function (e) {
        if(!$('#toCalendar').hasClass('disabled') && flag) {
            calendarTryAgain()
            flag = false;
        }
    });

    $('#details-tab-head').on('click', function (e) {
        flag = true;
    });

    $('#toCalendar').on('click', function (e) {
        flag = false;
    });

    function buildSprint(sprint) {
        const mainDiv = document.getElementById("sprints")
        // make the main container for all the sprints
        const sprintDiv = document.createElement("div")
        sprintDiv.className = "row row_sprints";
        mainDiv.appendChild(sprintDiv)

        const col2 = document.createElement("div")
        col2.className = "col-2"
        sprintDiv.appendChild(col2)

        const col1 = document.createElement("div")
        col1.className = "col-lg-1 col-md-2 col-sm-12 col-12 align-items-end "
        sprintDiv.appendChild(col1)

        const label = document.createElement("div")
        label.className = "portion_sprintbody project_sprinthead "
        label.innerText = sprint.label
        col1.appendChild(label)

        const editButton = document.createElement("button")
        editButton.className = "edit"
        editButton.innerText = "EDIT"
        col1.appendChild(editButton)

        const deleteForm = document.createElement("form")
        deleteForm.method = "post"
        deleteForm.action = "delete-sprint"
        col1.appendChild(deleteForm)

        const deleteProjectId = document.createElement("input")
        deleteProjectId.style = "display:none;"
        deleteProjectId.name = "deleteprojectId"
        deleteProjectId.id = "deleteprojectId"
        deleteProjectId.value = sprint.parentProjectId
        deleteProjectId.type = "number"
        deleteForm.appendChild(deleteProjectId)

        const deleteSprintId = document.createElement("input")
        deleteSprintId.style = "display:none;"
        deleteSprintId.name = "sprintId"
        deleteSprintId.id = "sprintId"
        deleteSprintId.value = sprint.id
        deleteSprintId.type = "number"
        deleteForm.appendChild(deleteSprintId)

        const deleteButton = document.createElement("button")
        deleteButton.className = "delete delete-button "
        deleteButton.innerText = "DELETE"
        deleteForm.appendChild(deleteButton)

        const br1 = document.createElement("br")
        const br2 = document.createElement("br")
        col1.appendChild(br1)
        col1.appendChild(br2)

        const col3 = document.createElement("div")
        col3.className = "col-lg-7 col-md-8 col-sm-12 portion_body"
        sprintDiv.appendChild(col3)

        const name = document.createElement("div")
        name.className = "sprint-title project_subhead "
        name.innerText = sprint.name
        col3.appendChild(name)

        const date = document.createElement("div")
        date.className = "sprint-date detail_date"
        date.innerText = sprint.startDateString + "-" + sprint.endDateString
        col3.appendChild(date)

        const description = document.createElement("div")
        description.className = "sprint-description project_edit_data"
        col3.appendChild(description)

        const col4 = document.createElement("div")
        col4.className = "col-2"
        sprintDiv.appendChild(col4)
    }

    var stompClient = null;

    function setConnected(connected) {
        $("#connect").prop("disabled", connected);
        $("#disconnect").prop("disabled", !connected);
        if (connected) {
            $("#conversation").show();
        }
        else {
            $("#conversation").hide();
        }
        $("#greetings").html("");
    }

    function connect() {
        var socket = new SockJS('/gs-guide-websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/calendar', function (update) {
                if (JSON.parse(update.body).updateType == "SPRINT") {
                    axios.get("/sprints", {params:{"id":[[${project.getId()}]]}})
                    .then((response) => {
                        deleteAllSprints()
                        for (const sprint of response.data) {
                            console.log(sprint)
                            buildSprint(sprint)
                        }
                        renderCalendar(response.data)
                    })
                }
            });
        });
    }

    function pausecomp(millis)
    {
        var date = new Date();
        var curDate = null;
        do { curDate = new Date(); }
        while(curDate-date < millis);
    }

   function calendarTryAgain() {
        axios.get("/sprints", {params:{"id":[[${project.getId()}]]}})
            .then((response) => {
                renderCalendar(response.data)
            })
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        console.log("Disconnected");
    }

    function send() {
        // template for now
        // stompClient.send("/app/hello", {}, JSON.stringify({'name': $("#name").val()}));
    }

    function renderCalendar(sprintList) {
        var calendarEl = document.getElementById('calendar');

        // Gets the date project end date and format's it as Date
        var endDate = new Date([[${project.getEndDate()}]].toString());

        // Add an extra day to end date since time is set to 00:00:00
        endDate.setDate(endDate.getDate() + 1);
        let selectedEvent;

        let sprintEvents = [];

        // Colors for the sprints
        const colors = ['#a3c7d7', '#067d46', '#19DAFF','#f5deb3', '#d470a2', '#9acd32',
            '#a2add0', '#c9a0dc', '#9f1d35', '#e34234', '#5b92e5', '#66023c',
            '#483c32', '#0abab5', '#eee600', '#f28500', '#ffcc33', '#a7fc00',
            '#cdc9c9', '#eee9e9', '#836fff', '#473c8b', '#708090', '#c0c0c0',
            '#ffd800', '#ff2400', '#e30b5d', '#003153', '#ff5a36', '#e5e4e2',
            '#cc3333', '#1c39bb', '#1ca9c9', '#002147', '#d3af37', '#30bfbf',
            '#fdbe02', '#eaa221', '#32cd32', '#c5cbe1'];

        // Loops through sprint list and saves it to be displayed on the calendar
        for (var sprintIndex = 0; sprintIndex < sprintList.length; sprintIndex++) {

            var sprintEndDate = new Date(sprintList[sprintIndex].endDate.toString());
            sprintEndDate.setDate(sprintEndDate.getDate() + 1);

            // Information about each sprint
            sprintEvents.push( {
                id: sprintList[sprintIndex].id,
                title: sprintList[sprintIndex].label,
                start: sprintList[sprintIndex].startDate,
                allDay: true,  //Can't resize from calendar view without this parameter
                end: sprintEndDate,
                durationEditable: false,
                // Mod so the sprint index doesn't go out of range for colors list
                color: colors[sprintIndex % colors.length],
                borderColor: 'white'
            });
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            eventClick: function (info) {
                if (selectedEvent) {
                    selectedEvent.setProp("durationEditable", false);
                    selectedEvent.setProp("borderColor", 'white');
                }
                info.event.setProp("durationEditable", true);
                info.event.setProp("borderColor", 'black');
                selectedEvent = info.event;
            },
            initialView: 'dayGridMonth',

            // Greys out area's not in use by the project
            validRange: {
                start: [[${project.getStartDate()}]],
                end: endDate
            },
            eventDurationEditable: true,
            eventResizableFromStart: true,
            eventOverlap: false,
            events: sprintEvents,
            displayEventTime : false,

            eventResize: function (eventResizeInfo) {
                let form = document.createElement('form'); // Creating the form which will be used to post new sprint data.
                form.setAttribute("th:action", "@{details}");
                form.setAttribute("method", "post");
                let formId = document.createElement("input"); // Adding sprint ID field to the form
                formId.setAttribute("type", "hidden");
                formId.setAttribute("th:name", "sprintId");
                formId.setAttribute("name", "sprintId");
                form.appendChild(formId);
                let formStart = document.createElement("input"); // Adding start date field to the form
                formStart.setAttribute("type", "hidden");
                formStart.setAttribute("th:name", "start");
                formStart.setAttribute("name", "start");
                form.appendChild(formStart);
                let formEnd = document.createElement("input"); // Adding end date field to the form
                formEnd.setAttribute("type", "hidden");
                formEnd.setAttribute("th:name", "end");
                formEnd.setAttribute("name", "end");
                form.appendChild(formEnd);
                form.elements["sprintId"].value = eventResizeInfo.event.id;
                form.elements["start"].value = eventResizeInfo.event.start;
                form.elements["end"].value = eventResizeInfo.event.end;
                document.body.append(form);
                form.submit() // Automatically submit form on move
            }
        });
        calendar.render();
        return calendar
    }

    function deleteAllSprints() {
        var e = document.getElementById("sprints");

        //e.firstElementChild can be used.
        var child = e.lastElementChild;
        while (child) {
            e.removeChild(child);
            child = e.lastElementChild;
        }
    }

    let initialSprintList = [[${sprints}]];

    for (const sprint of initialSprintList) {
        buildSprint(sprint)
    }

    document.addEventListener('DOMContentLoaded', function() { renderCalendar(initialSprintList) });

    //setTimeout(function() {console.log("CHANGE"); renderCalendar([])}, 1000*10)
    connect();

</script>

<!-- JS -->
<script type="text/javascript" th:src="@{js/bootstrap.bundle.min.js}"></script>
<!-- JS file for FullCalendar -->
<script th:src="@{js/fullcalendar.js}"></script>
</body>
</html>

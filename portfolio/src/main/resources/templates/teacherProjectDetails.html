<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${project.getName}"></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/album/">

    <!-- Bootstrap core CSS -->
    <link th:href="@{css/bootstrap.css}" rel="stylesheet">
    <link th:href="@{css/stylesheet.css}" rel="stylesheet">
    <!-- For dropdown to work -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- For the FullCalendar to work -->
    <link th:href="@{css/fullcalendar.css}" rel="stylesheet">
</head>
<body>


<!-- Navigation Bar -->
<div th:replace="fragments/validUser.html :: navbar"></div>



<!-- Body -->
<div class="main">
    <div class="container">

        <div class="row-1">
            <br><br><br>
        </div>

        <!-- Editing heading -->

        <div class="row-1">

            <div class="col-12 ">
                <p class="body_title_large " th:text="${project.getName}" />
                <p class="header_project_dates" th:text="'Start Date: ' + ${project.getStartDateString} + ' - ' + 'End Date: ' + ${project.getEndDateString}"/>
                <br>
            </div>

        </div>

        <!-- Tab Buttons -->
        <ul class="nav nav-tabs h4" style="font-family: nexaBold;">
            <li class="active"><a data-toggle="tab" href="#calendar-tab">Planner</a></li>
            <li><a data-toggle="tab" href="#project-details-tab">Project Details</a></li>
        </ul>

        <!-- Tab containers-->
        <div class="tab-content">
            <div id="calendar-tab" class="tab-pane fade in active">
                <br><br>

                <div id="calendar"></div>

                <br>
                <br>

                <button class="signup_box_green "th:style="${successCalendarShow}">
                    <p class="signup_error_green" th:text="${successCalendarCode}"/>
                </button>
                <button class="signup_box"th:style="${errorCalendarShow}">
                    <p class="signup_error" th:text="${errorCalendarCode}"/>
                </button>
            </div>

            <div id="project-details-tab" class="tab-pane fade">
                <br><br>

                <div class="row">
                    <div class="col-2"></div>
                    <div class="col-lg-8 col-md-10 col-sm-12 portion_body">
                    <div class="col-lg-8 col-md-10 col-sm-12 portion_body">

                        <p class="detail_date " th:text="${project.getStartDateString} + ' - ' + ${project.getEndDateString}" />

                            <div class="horizontal_field project_subtext" th:text="${project.getDescription}" /> </div>

                        <div class="col-2"></div>

                </div>

                <div class="row">
                    <div class="col-2"></div>

                        <!-- Buttons -->
                        <div class="col-lg-8 col-md-10 col-sm-12">

                            <button class="edit" style="padding-top:0rem;">
                                <a class="button_a" th:href="@{/edit-project(id=${project.getId})}">Edit Project</a>
                            </button>
                        </div>
                        <div class="col-2"></div>

                    </div>

                    <br>

                    <div class="row row_sprints"  th:each="sprint: ${sprints}">


                        <div class="col-2"></div>

                        <!-- Buttons -->

                        <div class="col-lg-1 col-md-2 col-sm-12 col-12 align-items-end ">


                            <div class="portion_sprintbody project_sprinthead " th:text="${sprint.getLabel}" />

                            <button class="edit">
                                <a class="button_a" th:href="@{'/edit-sprint?id=' + ${sprint.getParentProjectId} + '&ids=' + ${sprint.getId}}">EDIT</a>
                            </button>

                            <form th:action="@{/delete-sprint}" method="post">

                                <input style="display:none;" th:name="deleteprojectId" id="deleteprojectId" th:value="${project.getId}" type="number">

                                <input style="display:none;" th:name="sprintId" id="sprintId" th:value="${sprint.getId}" type="number">


                                <button class="delete delete-button ">DELETE</button>
                            </form>
                            <br>
                            <br>

                        </div>

                        <!-- Sprint info -->
                        <div class="col-lg-7 col-md-8 col-sm-12 portion_body">


                            <div class="sprint-title project_subhead " th:text="${sprint.getName}" />

                            <div class="sprint-date detail_date" th:text="${sprint.getStartDateString} + ' - ' + ${sprint.getEndDateString}" />

                            <div class="sprint-description project_edit_data" th:text="${sprint.getDescription}" />

                        </div>

                        <div class="col-2"></div>

                    </div>

                    <div class="row">

                        <div class="col-2"></div>

                        <!-- Buttons -->

                        <div class="col-lg-8 col-md-10 col-sm-12" >
                            <form th:action="@{new-sprint}" method="post">
                                <input style="display:none;" th:name="projectId" id="projectId" th:value="${project.getId}" type="number">
                                <button class="add" type="submit">
                                    Add Sprint
                                </button>
                            </form>
                            <br>
                            <button class="login_box "th:style="${errorShow}">
                                <p class="login_error" th:text="${errorCode}"/>
                            </button>
                            <button class="edit ">
                                <a class=" button_a" th:href="@{/landing}">      Return      </a>
                            </button>
                            <br><br>
                        </div>

                        <div class="col-2"></div>

                    </div>

                    <div class="row-1">
                        <br><br><br>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>


<!-- Javascript for the calendar -->
<script type="text/javascript" th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // Gets the date project end date and format's it as Date
        var endDate = new Date([[${project.getEndDate()}]].toString());

        // Add an extra day to end date since time is set to 00:00:00
        endDate.setDate(endDate.getDate() + 1);

        let sprintList = [[${sprints}]];
        let sprintEvents = [];

        // Colors for the sprints
        const colors = ['#a3c7d7', '#067d46', '#19DAFF','#f5deb3', '#d470a2', '#9acd32',
                        '#a2add0', '#c9a0dc', '#9f1d35', '#e34234', '#5b92e5', '#66023c',
                        '#483c32', '#0abab5', '#eee600', '#f28500', '#ffcc33', '#a7fc00',
                        '#cdc9c9', '#eee9e9', '#836fff', '#473c8b', '#708090', '#c0c0c0',
                        '#ffd800', '#ff2400', '#e30b5d', '#003153', '#ff5a36', '#e5e4e2',
                        '#cc3333', '#1c39bb', '#1ca9c9', '#002147', '#d3af37', '#30bfbf',
                        '#fdbe02', '#eaa221', '#32cd32', '#c5cbe1'];

        // Loops through sprint list and saves it to be displayed on the calendar
        for (var sprintIndex = 0; sprintIndex < sprintList.length; sprintIndex++) {

            var sprintEndDate = new Date(sprintList[sprintIndex].endDate.toString());
            sprintEndDate.setDate(sprintEndDate.getDate() + 1);

            // Information about each sprint
            sprintEvents.push( {
                id: sprintList[sprintIndex].id,
                title: sprintList[sprintIndex].label,
                start: sprintList[sprintIndex].startDate,
                allDay: true,  //Can't resize from calendar view without this parameter
                end: sprintEndDate,

                // Mod so the sprint index doesn't go out of range for colors list
                color: colors[sprintIndex % colors.length]
            });
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {

            initialView: 'dayGridMonth',

            // Greys out area's not in use by the project
            validRange: {
                start: [[${project.getStartDate()}]],
                end: endDate
            },
            editable: true,
            eventDurationEditable: true,
            eventStartEditable: true,
            eventResizableFromStart: true,
            eventOverlap: true,
            events: sprintEvents,
            displayEventTime : false,
            eventResize: function (eventResizeInfo) {
                console.log("test");
                let form = document.createElement('form'); // Creating the form which will be used to post new sprint data.
                form.setAttribute("th:action", "@{/details}");
                form.setAttribute("method", "post");
                let formId = document.createElement("input"); // Adding sprint ID field to the form
                formId.setAttribute("type", "hidden");
                formId.setAttribute("th:name", "sprintId");
                formId.setAttribute("name", "sprintId");
                form.appendChild(formId);
                let formStart = document.createElement("input"); // Adding start date field to the form
                formStart.setAttribute("type", "hidden");
                formStart.setAttribute("th:name", "start");
                formStart.setAttribute("name", "start");
                form.appendChild(formStart);
                let formEnd = document.createElement("input"); // Adding end date field to the form
                formEnd.setAttribute("type", "hidden");
                formEnd.setAttribute("th:name", "end");
                formEnd.setAttribute("name", "end");
                form.appendChild(formEnd);
                console.log(form.childNodes);
                form.elements["sprintId"].value = eventResizeInfo.event.id;
                form.elements["start"].value = eventResizeInfo.event.start;
                form.elements["end"].value = eventResizeInfo.event.end;
                document.body.append(form);
                form.submit() // Automatically submit form on move
            }
        });
        console.log("test2");
        calendar.render();
    });

</script>

<!-- JS -->
<script type="text/javascript" th:src="@{js/bootstrap.bundle.min.js}"></script>
<!-- JS file for FullCalendar -->
<script th:src="@{js/fullcalendar.js}"></script>
</body>
</html>
